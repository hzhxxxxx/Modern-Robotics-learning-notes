
### 【1】控制系统概述

每一种情况下，机器人控制器的工作是将任务要求转换为执行器上的力和力矩，
相应的控制策略被称为运动控制、力控制、混合运动力控制或阻抗控制，选取何种控制策略取决于任务和环境。

而一个典型的控制框图如下所示
![[Pasted image 20250722140600.png]]

而我们将放大器，执行器和变速器集中在一起，视为完美发挥其功能的假设，则可以简化成下图。
![[Pasted image 20250722140715.png]]


### 【2】误差响应

- 1，*误差响应*
	如果期望关节位置为$\theta_d(t)$，而实际关节位置为$\theta(t)$，那么我们将关节误差响应定义为：$$\theta_e(t)=\theta_d(t)-\theta(t)$$

- 2,误差响应的图
	其实是（单位）误差响应，我们将初始误差设定为1，$\theta_e(0)=1$。然后观察误差随时间的变化。
	![[Pasted image 20250722141525.png]]
	最后误差会趋近一个稳定的值，这个叫做*稳态误差*
	
	而图里还有两个值得关注的值这两个都属于瞬态误差，一个是*调节时间*：调节到某一允许误差范围（通常是2%）内所需的时间，即对于所有的时间$t$，当$t>=T$第一次实现$\left|\theta_e(t)-e_{\mathrm{ss}}\right| \leq 0.02\left(\theta_e(0)-e_{\mathrm{ss}}\right)$这一条件的时间$T$。
	
	*超调*：$$\text{超调} = \left| \frac{\theta_{e,\min} - e_{\text{ss}}}{\theta_{e}(0) - e_{\text{ss}}} \right| \times 100\%$$其实就是最大调节偏差值相对于整体初始偏差值的比值
	
	一个好的误差响应应有下列特征：
	没有稳态误差或者很小
	没有超调或者很小
	2%调节时间很短



### 【3】误差动力学

*其实就是上面的误差响应图可以通过一个线性微分方程来描述。其都代表了误差$\theta_e(t)$随时间演化的数学模型。*
$$a_p\theta_e^{(p)}+a_{p-1}\theta_e^{(p-1)}+\cdots+a_2\ddot{\theta}_e+a_1\dot{\theta}_e+a_0\theta_e=c.$$
这里的$\theta_e^{(p)}$是代表$\theta_e$的$p$阶导的意思
当$c=0$时为齐次方程，代表系统无扰动或外部输入的自由响应
当$c≠0$时为非齐次方程，代表可能有外部的干扰或有输入
以下我们都讨论$c=0$的齐次方程情况。

这个方程可以改写成：$$\theta_{e}^{(p)}=-a_{p-1}^{\prime}\theta_{e}^{(p-1)}-\cdots-a_{2}^{\prime}\ddot{\theta}_{e}-a_{1}^{\prime}\dot{\theta}_{e}-a_{0}^{\prime}\theta_{e}.$$可以定义这些变量$\theta_e(t)$为$x$,
$$\begin{aligned}
 & x_{1}=\theta_{e}, \\
 & x_{2}=\dot{x}_1=\dot{\theta}_e, \\
 & \dot{x}_{p}=-a_{0}^{\prime}x_{1}-a_{1}^{\prime}x_{2}-\cdots-a_{p-1}^{\prime}x_{p}
\end{aligned}$$
可以通过一个矩阵乘法$\dot{x}(t)=Ax(t)$把这些信息打包👇，$$A=
\begin{bmatrix}
0 & 1 & 0 & \cdots & 0 & 0 \\
0 & 0 & 1 & \cdots & 0 & 0 \\
\vdots & \vdots & \vdots & \ddots & \vdots & \vdots \\
0 & 0 & 0 & \cdots & 1 & 0 \\
0 & 0 & 0 & \cdots & 0 & 1 \\
-a_0^{\prime} & -a_1^{\prime} & -a_2^{\prime} & \cdots & -a_{p-2}^{\prime} & -a_{p-1}^{\prime}
\end{bmatrix}$$对于这个矩阵来说，其特征值$s$可以构成一个方程，叫做*特征方程*$$s^{p}+a_{p-1}^{\prime}s^{p-1}+\cdots+a_{2}^{\prime}s^{2}+a_{1}^{\prime}s+a_{0}^{\prime}=0$$

接下来讨论一下*系统的稳定性*，因为系统的稳定性与特征方程息息相关。
- 1，*特征方程的每个根都具有负实部*（也就是位于复平面左半平面）时，系统才是稳定的。
- 2，系统稳定的话，特征方程所有系数必须>0。但是反之所有系数都>0不一定一定是稳定系统。所以只能快速初步地筛选一下。
- 3，*劳斯判据*：
	对于这样的特征方程$a_{0}s^{n}+a_{1}s^{n-1}+\cdots+a_{n-1}s+a_{n}=0$
	可以列劳斯表：
	![[Pasted image 20250722150631.png]]
	系统稳定的条件是第一列的各数值都为正数。
	而第一列符号改变的次数代表特征方程的正实根数目，也就是位于右半平面的特征根个数。



### 【4】一阶和二阶误差动力学

- 引入：
	我们要记住一个很典型的机械类比，线性的质量-弹簧-阻尼系统。
	质量块$m$的位置为$\theta_\mathrm{e}$,并且有一个外力$f$作用于该质量块。
	阻尼器对质量块施加一个力$-b\dot{\theta}_{e}$,其中$b$是阻尼常数；
	弹簧对质量块施加一个力$-k\theta_e$,其中$k$是弹簧常数。
	因此，质量块的运动方程可以表示为$$m\ddot{\theta}_e+b\dot{\theta}_e+k\theta_e=f$$


- *一阶误差动力学*：
	当质量块$m$趋近于0的时候，二阶动力学降阶为一阶动力学。
	$$b\dot{\theta}_e+k\theta_e=f$$       然后我们考虑齐次情况（$f=0$）,上面方程变成$$\dot{\theta}_e(t)+\frac{k}{b}\theta_e(t)=0$$       其中我们定义$t=b/k$，则$$\dot{\theta}_e(t)+\frac{1}{t}\theta_e(t)=0$$       注意这里是一个一阶微分方程的时间常数，是大约衰减到初始值37%大小时所对应的时间
	
	对于一阶系统的2%误差的调节时间，约为$4t$（依旧是时间常数）
	![[Pasted image 20250722152156.png]]




- *二阶误差动力学*：
	则运动方程可以写为$$\ddot{\theta}_e(t)+\frac{b}{\mathfrak{m}}\dot{\theta}_e(t)+\frac{k}{\mathfrak{m}}\theta_e(t)=0$$转换成标准的二阶系统形式：$$\color{#fb8b05}\ddot{\theta}_e(t)+2\zeta\omega_n\dot{\theta}_e(t)+\omega_n^2\theta_e(t)=0$$式中$\omega_n$称为*自然频率*，$\omega_{n}=\sqrt{k/\mathfrak{m}}$
	$\zeta$称为*阻尼比*，$\zeta=b/(2\sqrt{k\mathfrak{m}})$
	
	二阶系统的特征方程为：$$\color{#fb8b05}s^2+2\zeta\omega_ns+\omega_n^2=0$$其中两个根为$$s_{1}=-\zeta\omega_{n}+\omega_{n}\sqrt{\zeta^{2}-1}\quad\mathrm{and}\quad s_{2}=-\zeta\omega_{n}-\omega_{n}\sqrt{\zeta^{2}-1}$$
	
	
	如果系统稳定的话，可以根据阻尼比$\zeta$的大小分为三种情况：
	1，*过阻尼*$\zeta>1$
	2，*临界阻尼*$\zeta=1$
	3，*欠阻尼*$\zeta<1$
	![[Pasted image 20250722153335.png]]
	
	


### 【5】速度控制（关节层面）

说白了就是控制器输出的都是速度，要控制的也是关节的速度

- 定点控制 和 轨迹控制
	关节的理想关节位置为${\theta}_d(t)$（定点控制），或者是期望的关节轨迹${\theta}_d(t)$（轨迹控制），这两者的区别就是，
	定点控制就像目标位置是常数，机械臂要到一个固定的点。$\dot{\theta}_d(t)=0$
	而轨迹控制，是目标位置一直在变化，就像在追赶一辆匀速行驶的车$\dot{\theta}_d(t)=c$，c是一个常数。


- 前馈控制（开环控制）
	默认是轨迹控制
	我们想要的速度就是轨迹的每时每刻的速度$$\dot{\theta}(t)=\dot{\theta}_d(t)$$


 反馈控制（闭环控制）：
 这部分主要就是PID的各个部分介绍
 
- *P 控制*
	其实P（比例）的控制思路就是：*控制速度 =  固定比例 × 误差*
	$$\color{#fb8b05}\dot{\theta}(t)=K_p\left(\theta_d(t)-\theta(t)\right)=K_p \theta_e(t)$$       比如期望位置 θ_d = 90° 
	当前位置 θ = 50°
	比例增益 K_p = 2
	那么：
	位置误差 θ_e = 90° - 50° = 40°
	控制速度 θ̇ = 2 × 40° = 80°/s
	
	P控制在定点控制中的优势：
	这个用在定点控制非常好用，因为在定点控制中，最后的误差动力学方程是
	$\dotθ_e + K_p * θ_e = 0$，这个其实就是跟我们上面讲的一阶误差动力学差不多。（推导的话，主要就是结合误差定义$θ_e = θ_d - θ$，然后求导$\dotθ_e = \dotθ_d - \dotθ$，并且定点控制的意义$\dot{\theta}_d(t)=0$，然后代入到P控制的式子中慢慢推出的，后面很多式子都是这么推出来的）
	
	P控制在轨迹控制中的缺点：
	但是在轨迹控制中就不太行了，因为*P控制的核心就是“只有看到误差，我才工作”*，而我们要追上一个常速运动的目标的话，就要持续输出一个稳定的速度，换句话说，为了持续输出速度，必须保持一个误差。（如果追上了没有误差，它就不输出速度了）这就导致P控制永远追不上，只能保持一个固定距离跟随。
	因此为了解决这个问题，我们引入了PI控制


- *PI控制*
	PI控制的思路就是*引入I（积分项），它累计了过去所有的误差，因此有”记忆“功能*
	$$\color{#fb8b05}\dot{\theta}(t)=K_p \theta_e(t)+K_i \int_0^t \theta_e(t) d t$$       简单来说，就是这个积分项的存在，使得即使当前误差为0，
	积分项因为累积了之前的        误差的原因，仍然有值，因此在零 误差的适合依然能产生输出速度。
	
	形象比喻：
	P控制：健忘的司机
	- 只看"当前距离差"
	- 距离为0 → 速度为0
	- "现在没差距了，我就不开了！"
	
	PI控制：有记忆的司机
	- 看"当前距离差" + "过去的距离累积"
	- 即使当前距离为0
	- 但记得"之前一直在追赶"
	- "虽然现在追上了，但我知道要保持速度！"
	
	它的误差动力学是：$$\ddot{\theta}_e(t)+K_p \dot{\theta}_e(t)+K_i \theta_e(t)=0$$其实就是二阶误差动力学的东西
	$\omega_n=\sqrt{K_i}$      $K_i→ 固有频率$
	$\zeta=K_p / 2 \sqrt{K_i}$     $K_p→ 阻尼比$


- 综合对比一下P和PI控制器的性能
	![[Pasted image 20251106163546.png]]


- *PID控制*
	$$\color{#fb8b05}\dot{\theta}(t)=K_p\theta_e+K_i\int\theta_e(\mathrm{t})d\mathrm{t}+K_d\dot{\theta}_e$$       这个D（微分）
	*引入误差对于时间的导数，就是引入误差的变化率，这样能够预测未来的趋势，进行提前响应，减小超调*
	
	加入D控制：
	不仅看距离，还看接近速度
	距离5米，但速度很快 → 提前刹车
	预判到"按这个速度会撞"，提前减速
	结果：平稳停下（减小超调）


- 前馈反馈控制器
	其实就是把两者结合起来，因为反馈控制的一个缺点是在关节开始运动之前需要有一个误差，因此在任何误差累积之前，最好利用我们对所需轨迹的了解来启动运动。$$\dot{\theta}(t)=\dot{\theta}_d(t)+K_p \theta_e(t)+K_i \int_0^t \theta_e(t) d \mathrm{t}$$


- *从末端执行的任务空间来应用前馈反馈控制器*
	
	我们之前讨论的都是关节空间，单个关节的角度和速度。现在推广到机器人的末端执行器中
	末端执行器的位姿误差：$X_e(t)$
	末端执行器的实际twist（控制输出）：$V_b$
	末端执行器的期望的twist（前馈项）：$V_d$
	$$\mathcal{V}_b(t)=\mathcal{V}_d(t)+K_p X_e(t)+K_i \int_0^t X_e(\mathrm{t}) d \mathrm{t}$$       然后又根据[[5.1 运动旋量or力旋量的雅可比矩阵映射（引入）]]
	$V=J(\theta)\dot{\theta}$
	可以实现关节速度和末端执行器速度的联系
	
	![[Pasted image 20251106164539.png]]



### 【6】力和力矩控制（关节层面）


- 考虑背景
	![[Pasted image 20251106182748.png]]$$\tau=M\ddot{\theta}+\mathfrak{m}gr\cos\theta+b\dot{\theta}$$控制力矩（电机力矩）$\tau$
	摩擦力矩$b\dot{\theta}$
	重力力矩$\mathfrak{m}gr\cos\theta$
	惯性项$M\ddot{\theta}$
	简写：$$\tau=M\ddot{\theta}+h(\theta,\dot{\theta})$$



- PD控制
	$$\tau=K_p\theta_e+K_d\dot\theta_e$$        这种控制方式也是有一个问题，跟之前的P控制->PI控制一样，就是它必须要看到误           差才干活，因此在垂直情况下，就也会出现，无法到达目标位置，只能保持一个                距离跟随的情况，因此引入PID控制


- PID控制
	$$\tau=K_p\theta_e+K_i\int\theta_e(\mathrm{t})d\mathrm{t}+K_d\dot{\theta}_e$$       下面是PID和PD的对比
	![[Pasted image 20251106183523.png]]


- 前馈控制
	其实前馈控制的核心思想就是，不等出现误差，直接给出正确的控制量结果
	我们这里因为有了这个模型的动力学公式，在第一个我们写的$\tau=M\ddot{\theta}+h(\theta,\dot{\theta})$，因此，前馈控制的式子就是这个。
	![[Pasted image 20251106184541.png]]


- 前馈+反馈PID
	其实也把之前的速度控制的式子加进来了
	$$\tau=\tilde{M}(\theta)\left(\ddot{\theta}_d+K_p\theta_e+K_i\int\theta_e(\mathrm{t})d\mathrm{t}+K_d\dot{\theta}_e\right)+\tilde{h}(\theta,\dot{\theta})$$

### 【7】多关节控制（关节层面）

普遍有两种方法
- 1，分散控制
	- 每个关节独立控制
	- 关节1用自己的PID
	- 关节2用自己的PID
	- 互不通信
	
	适用条件：
	- 质量矩阵M是对角阵（动力学解耦）
	![[Pasted image 20251106190526.png]]
	- 例如：直角坐标机器人（xyz三个滑动关节，互不影响）


- 集中控制
	考虑关节间耦合
	$\tau=\tilde{M}(\theta)\left(\ddot{\theta}_d+K_p\theta_e+K_i\int\theta_e(\mathrm{t})d\mathrm{t}+K_d\dot{\theta}_e\right)+\tilde{h}(\theta,\dot{\theta})$
	只不过式子中都是n维向量了
	适用条件：
	- 质量矩阵M不是对角阵（有耦合）
	![[Pasted image 20251106190740.png]]
	- 例如：旋转关节机器人（多个关节串联）


- 末端任务空间中的控制
	也是有两种思路
	1，转换到关节空间
	![[Pasted image 20251106191135.png]]
	2，直接在末端任务空间中写动力学式子
	![[Pasted image 20251106191115.png]]


### 【8】，力控制（末端层面）
就是我们讨论的问题到了 末端执行器 的 力上面

普通式子是：$$\tau=\tilde{g}(\theta)+J^{\mathrm{T}}(\theta) \mathcal{F}_d$$左边是各个关节的力矩，

中间的是重力力矩：机械臂的每个连杆都有重量，重力会让连杆往下掉。为了保持机械臂的姿态不变，每个关节的电机需要提供一个力矩来对抗重力，这个力矩就是重力力矩。

右边是末端力旋量 和 关节力矩 的雅可比联系，详见[[5.1 运动旋量or力旋量的雅可比矩阵映射（引入）]]

加上一个使用前馈+PI的控制器
$$
\color{#fb8b05}\tau=\tilde{g}(\theta)+J^{\mathrm{T}}(\theta)\left(\mathcal{F}_d+K_{f p} \mathcal{F}_e+K_{f i} \int \mathcal{F}_e(\mathrm{t}) d \mathrm{t}\right)
$$


### 【9】，混合运动-力控制（末端层面）

公式太复杂了，就记个定义吧：
  在不同方向上，分别做运动控制和力控制

  - 某些方向：控制位置/速度（运动控制）
  - 其他方向：控制力（力控制）

  典型应用

  - 擦桌子：垂直方向控制压力，水平方向控制轨迹
  - 装配：插入方向控制力，其他方向控制位置
  - 抛光：法向控制接触力，切向控制运动路径


### 【10】，阻抗控制（末端层面）

 就是让机器人的末端表现得像一个"虚拟的弹簧-阻尼-质量系统"
 其实就是“拖动示教”机械臂时候的感觉

![[Pasted image 20251108162547.png]]

$$\mathfrak{m}\ddot{x}+b\dot{x}+kx=f$$m, b, k：你设定的虚拟质量、阻尼、刚度（可以自己调）
f ：外界施加的力


（1），高阻抗 vs 低阻抗
  看传递函数：
  Z(s) = F(s)/X(s)

  阻抗的意思：
  - 高阻抗（刚硬）：给一点力，位移很小 → 适合位置控制
  - 低阻抗（柔软）：给一点力，位移很大 → 适合力控制

  导纳 Y(s) = 1/Z(s) 是阻抗的倒数。

  低阻抗（柔软）→ 力控制
  - 就像拖动示教时的感觉
  - 你轻轻一推，机器人就顺从地移动
  - 力的效果很明显 → 适合做力控制任务
  - 例子：人机协作、手术机器人、按摩

  高阻抗（刚硬）→ 位置控制
  - 机器人"很硬"，推不动
  - 位置很稳定，不容易被外力干扰
  - 适合精确定位任务
  - 例子：焊接、精密装配


（2），两种实现方式
  核心区别：测什么、控什么

  1， Impedance Control（阻抗控制）
  传感器：只有位置传感器（关节编码器），没有力传感器

  工作流程：
  1. 测量末端位置 x
  2. 根据阻抗模型算出"应该产生多大的力"
  3. 控制电机产生这个力

  公式：
  τ = J^T · (Λ·ẍ + η̃ - (M·ẍ + B·ẋ + K·x))

  特点：用位置偏差来"假装"有外力，然后产生反作用力


  2，Admittance Control（导纳控制）
  传感器：有力传感器（六维力/力矩传感器）

  工作流程：
  4. 力传感器直接测量外力 f_ext
  5. 根据阻抗模型算出"应该移动到哪里"
  6. 控制位置运动

  公式：
  ẍ_d = M^(-1) · (f_ext - B·ẋ - K·x)

  特点：直接测力，然后计算应该如何运动


3，简单类比
 阻抗控制：
  - 你推门 → 门的位置变了 → 门"猜"你推了多大力 → 给你反作用力
  - （没有力传感器，靠位置变化推测力）

  导纳控制：
  - 你推门 → 门直接测到你的推力 → 决定移动多少
  - （有力传感器，直接知道力）